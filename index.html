<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS - เครื่องคิดเงิน</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; margin: 0; padding: 0; }
        h1, h2 { color: #333; }
        .main-container { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; padding: 20px; height: 100vh; box-sizing: border-box; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; overflow-y: auto; padding-right: 10px; max-height: 85vh; }
        .product-card { background-color: #ffffff; border: 1px solid #ddd; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); text-align: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .product-card h3 { margin: 0 0 10px 0; font-size: 1em; }
        .product-card p { margin: 0; color: #007bff; font-weight: bold; }
        .cart { background-color: #ffffff; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .cart-items { flex-grow: 1; overflow-y: auto; }
        .cart-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
        .cart-total { border-top: 2px dashed #ccc; padding-top: 15px; margin-top: 15px; text-align: right; font-size: 1.5em; font-weight: bold; }
        .cart-actions { margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn { padding: 15px; border: none; border-radius: 8px; font-size: 1em; font-weight: bold; cursor: pointer; transition: opacity 0.2s; }
        .btn:hover { opacity: 0.8; }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-success { background-color: #28a745; color: white; }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="product-selection">
            <h1>เลือกสินค้า</h1>
            <div class="product-grid" id="product-grid-container"></div>
        </div>
        <div class="cart">
            <h2>รายการสั่งซื้อ</h2>
            <div class="cart-items" id="cart-items-container"><p style="color: #888;">ยังไม่มีสินค้าในรายการ</p></div>
            <div class="cart-total" id="cart-total-container">ยอดรวม: 0.00 บาท</div>
            <div class="cart-actions">
                <button class="btn btn-danger" id="clear-cart-button">ล้างตะกร้า</button>
                <button class="btn btn-success" id="pay-button">คิดเงิน</button>
            </div>
        </div>
    </div>

    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzUOpEebHFrQ5leB707QlmH3hAHgd6orEpjGrXYMJ7vPV9_CqpVtuZeqHojPs5iZVWPoQ/exec';
        let allProducts = [];
        let cartItems = [];

        document.addEventListener('DOMContentLoaded', () => {
            fetchProducts();
            document.getElementById('clear-cart-button').addEventListener('click', () => {
                if (confirm('คุณต้องการล้างตะกร้าสินค้าทั้งหมดใช่หรือไม่?')) {
                    cartItems = [];
                    renderCart();
                }
            });
            document.getElementById('pay-button').addEventListener('click', handlePayment);
        });

        function fetchProducts() { /* ... โค้ดส่วนนี้เหมือนเดิม ... */
            const gridContainer = document.getElementById('product-grid-container');
            gridContainer.innerHTML = '<p>กำลังโหลดรายการสินค้า...</p>';
            fetch(WEB_APP_URL).then(response => response.json()).then(products => {
                allProducts = products;
                gridContainer.innerHTML = ''; 
                products.forEach(product => {
                    const card = document.createElement('div');
                    card.className = 'product-card';
                    card.innerHTML = `<h3>${product.ProductName}</h3><p>${product.Price.toFixed(2)} บาท</p>`;
                    card.addEventListener('click', () => { addToCart(product.ProductID); });
                    gridContainer.appendChild(card);
                });
            }).catch(error => {
                console.error('เกิดข้อผิดพลาด:', error);
                gridContainer.innerHTML = '<p style="color: red;">โหลดข้อมูลสินค้าไม่สำเร็จ</p>';
            });
        }
        function addToCart(productId) { /* ... โค้ดส่วนนี้เหมือนเดิม ... */
            const existingItem = cartItems.find(item => item.ProductID === productId);
            if (existingItem) { existingItem.quantity++; } else { const productToAdd = allProducts.find(p => p.ProductID === productId); if (productToAdd) { cartItems.push({ ...productToAdd, quantity: 1 }); } }
            renderCart();
        }
        function renderCart() { /* ... โค้ดส่วนนี้เหมือนเดิม ... */
            const cartContainer = document.getElementById('cart-items-container');
            const totalContainer = document.getElementById('cart-total-container');
            if (cartItems.length === 0) { cartContainer.innerHTML = '<p style="color: #888;">ยังไม่มีสินค้าในรายการ</p>'; totalContainer.innerHTML = 'ยอดรวม: 0.00 บาท'; return; }
            cartContainer.innerHTML = ''; let total = 0;
            cartItems.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'cart-item';
                const itemTotalPrice = item.Price * item.quantity;
                total += itemTotalPrice;
                itemDiv.innerHTML = `<span class="cart-item-name">${item.ProductName}</span><span class="cart-item-qty">x${item.quantity}</span><span class="cart-item-price">${itemTotalPrice.toFixed(2)}</span>`;
                cartContainer.appendChild(itemDiv);
});
            totalContainer.innerHTML = `ยอดรวม: ${total.toFixed(2)} บาท`;
        }

        // *** ฟังก์ชัน handlePayment เวอร์ชันอัปเกรด! ***
        function handlePayment() {
            if (cartItems.length === 0) {
                alert('ตะกร้าสินค้าว่างเปล่า!');
                return;
            }
            const totalAmount = cartItems.reduce((sum, item) => sum + item.Price * item.quantity, 0);
            const confirmed = confirm(`ยอดรวมทั้งหมด ${totalAmount.toFixed(2)} บาท ยืนยันการขายใช่หรือไม่?`);

            if (confirmed) {
                const payButton = document.getElementById('pay-button');
                payButton.disabled = true; // ปิดปุ่มกันการกดซ้ำ
                payButton.textContent = 'กำลังบันทึก...';

                // ใช้ fetch() เพื่อส่งข้อมูลไปที่ doPost ของ Apps Script
                fetch(WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(cartItems) // แปลงตะกร้าของเราเป็น JSON String
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('บันทึกการขายสำเร็จ!');
                        cartItems = []; // ล้างตะกร้า
                        renderCart(); // วาดตะกร้าใหม่
                    } else {
                        alert('เกิดข้อผิดพลาดในการบันทึก: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('เกิดข้อผิดพลาดร้ายแรง ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้');
                })
                .finally(() => {
                    // ไม่ว่าจะสำเร็จหรือล้มเหลว ให้เปิดปุ่มกลับมาเหมือนเดิม
                    payButton.disabled = false;
                    payButton.textContent = 'คิดเงิน';
                });
            }
        }
    </script>
</body>
</html>
